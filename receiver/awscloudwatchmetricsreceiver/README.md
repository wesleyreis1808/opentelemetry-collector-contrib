# AWS CloudWatch Metrics Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fawscloudwatchmetrics%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fawscloudwatchmetrics) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fawscloudwatchmetrics%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fawscloudwatchmetrics) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    |  |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

Receives CloudWatch metrics from [AWS CloudWatch](https://aws.amazon.com/cloudwatch/) via the [AWS SDK for CloudWatch Metrics](https://docs.aws.amazon.com/sdk-for-go/api/service/cloudwatch/)

## Getting Started

This receiver uses the [AWS SDK](https://aws.github.io/aws-sdk-go-v2/docs/configuring-sdk/) as mode of authentication, which includes [Profile](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html) and [IMDS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) authentication for EC2 instances.

By default the receiver collects *no* metrics.

## Configuration

### Top Level Parameters

| Parameter       | Notes      | type   | Description                                                                                                                                                                                                                                                                       |
| --------------- | ---------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `region`        | *required* | string | The AWS recognized region string.  |
| `profile`       | *optional* | string | The AWS profile used to authenticate, if none is specified the default is chosen from the list of profiles.  |
| `imds_endpoint`  | *optional* | string | The IMDS endpoint to authenticate to AWS.  |
| `poll_interval`   | `default=5m` | duration   | The duration waiting in between requests. | 
| `metrics`          | *required* | `Metrics` | Configuration for metrics ingestion of this receiver.    |

### Metrics Parameters


| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `named`                 | *one key required*   | `[]NamedMetric` | Configuration for named metrics. Used to get specific metrics.  |
| `autodiscover`        | *one key required* | `Autodiscovery` | Configuration for autodiscovery of metrics.

### Named Metric Parameters

| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `namespace`                 | *required*   | string | AWS Metric namespace, all AWS namespaces are prefixed with `AWS`, eg: `AWS/EC2` for EC2 metrics. |
| `metric_name` | *required* | string | Name of metric. |
| `period` | *required* | duration | Aggregation period. Period have be 1, 5, 10, 30, 60, or any multiple of 60 seconds. | 
| `aws_aggregation` | *required* | string | Type of AWS aggregation, eg: Sum, Average, Minimum, Maximum. See AWS [docs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Statistics-definitions.html). |
| `dimensions` | *optional* | `MetricDimension` | Configuration for metric dimensions. You should note AWS CloudWatch cannot unroll metrics, and so some dimensions are required for metrics data to be returned such a `InstanceId` for EC2 metrics or `ApiId` for ApiGateway. |

### Autodiscovery Parameters
| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `namespace`                 | *required*   | string | AWS Metric namespace used in metrics discovery.|
| `metric_name` | *optional* | string | Name of metric used in metrics discovery.  |
| `period` | *required* | duration | Aggregation period used to get metrics data. Period have be 1, 5, 10, 30, 60, or any multiple of 60 seconds | 
| `aws_aggregation` | *required* | string | Type of AWS aggregation used to get metrics data. Eg: Sum, Average, Minimum, Maximum. See AWS [docs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Statistics-definitions.html). |
| `dimensions` | *optional* | `[]MetricDimension` | Configuration for metric dimensions used in metrics discovery. |



### MetricDimension Parameters

| Parameter                | Notes        | type                   | Description                                                                                |
| ------------------------ | ------------ | ---------------------- | ------------------------------------------------------------------------------------------ |
| `name`                 | *required*   | string | Dimensions name, can't start with a colon |
| `value` | *required* | string | Dimension value |

## Example

### Named Example

```yaml
receivers:
  awscloudwatchmetrics:
    region: "eu-west-2"
    profile: "my_profile"
    imds_endpoint: ""
    poll_interval: "1m"
    metrics:
      named:
        - namespace: "AWS/EC2"
          period: "5m"
          metric_name: "CPUUtilization"
          aws_aggregation: "Average"
          dimensions:
            - name: "InstanceId"
              value: "i-1234567890abcdef0"
        - namespace: AWS/ApiGateway
          metric_name: Latency
          period: "60s"
          aws_aggregation: Average
          dimensions:  
            - name: Resource
              value: /
            - name: Method
              value: GET
            - name: Stage
              value: $$default
            - name: ApiId
              value: apiid1234
exporters:
  debug:
    verbosity: detailed

service:
  telemetry:
    logs:
      level: "debug"
  pipelines:
    metrics:
      receivers: [awscloudwatchmetrics]
      processors: []
      exporters: [debug]
```

## Autodiscovery Example

```yaml
receivers:
  awscloudwatchmetrics:
    region: "us-west-2"
    profile: "my_profile"
    imds_endpoint: ""
    poll_interval: "1m"
    metrics:
      autodiscover:
        namespace: "AWS/EC2"
        aws_aggregation: "Average"
        period: "5m"
        dimensions:
          - name: "InstanceId"
            value: "i-1234567890abcdef0"
exporters:
  debug:
    verbosity: detailed

service:
  telemetry:
    logs:
      level: "debug"
  pipelines:
    metrics:
      receivers: [awscloudwatchmetrics]
      processors: []
      exporters: [debug]
```

## AWS Costs

This receiver uses the [GetMetricData](https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html) API call, this call is *not* in the AWS free tier. Please refer to [Amazon's pricing](https://aws.amazon.com/cloudwatch/pricing/) for further information about expected costs.

## Features not supported

- This receiver currently does not support [metric math](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html) to return new time series based on a mathematical expressions.

- For better performance AWS recommends modifying the `StartTime` and `EndTime` to align with the metric's period and start/end of the hour. For example, a metric with a period of 5 minutes and a start-time of 18:55 can get better [performance than specifying a start-time of 18:51](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudwatch/client/get_metric_data.html). This receiver does not currently implement this logic.

## Troubleshooting

### My metrics are not being discovered

AWS CloudWatch [ListMetrics API call](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudwatch/list-metrics.html) does not return information about metrics if those metrics haven't had any updates in the past two weeks.

Some issues that appear during metrics discovery may be related to settings. To make sure the parameters are correct, you can test them using the AWS CLI.

```bash
cat <<EOF > list-metrics-query.json
{
  "Namespace": "AWS/ApiGateway",
  "MetricName": "Latency",
  "Dimensions": [
      {
          "Name": "ApiId",
          "Value": "apiid123"
      }
  ]
}
EOF
# Get list metrics using AWS CLI
aws cloudwatch list-metrics \
  --profile MY_PROFILE \
  --cli-input-json file://list-metrics-query.json > list-metrics.json
```

After executing the commands you can check the `list-metrics.json` file if the desired metrics were returned.

### My metrics are discovered but not being collected

In some cases it may occur that the metric is discovered, but does not have data within the `StartTime` and `EndTime` used. The receiver collects this data periodically according to the value configured in `poll_interval`, where `EndTime=timeNow()` and `StartTime=timeNow() - poll_interval`. To increase the time window used for collection, simply increase the value of `poll_interval`.

You can test collecting metrics data using the AWS CLI. The commands below perform a `GetMetricData` operation based on the query defined in the `metric-data-query.json` file.

```bash
cat <<EOF > metric-data-query.json
{
  "MetricDataQueries": [
    {
      "Id": "m1",
      "MetricStat": {
        "Metric": {
          "Namespace": "AWS/ApiGateway",
          "MetricName": "Latency",
          "Dimensions": [
            {
              "Name": "Resource",
              "Value": "/"
            },
            {
              "Name": "Stage",
              "Value": "$default"
            },
            {
              "Name": "Method",
              "Value": "GET"
            },
            {
              "Name": "ApiId",
              "Value": "apiid123"
            }
          ]
        },
        "Period": 60,
        "Stat": "Average",
      },
      "ReturnData": true
    }
  ],
  "StartTime": "2024-06-06T21:11:57",
  "EndTime": "2024-06-06T22:11:57"
}
EOF

# Get metric data using AWS CLI
aws cloudwatch get-metric-data \
  --profile MY_PROFILE \
  --cli-input-json file://metric-data-query.json > results/metric-data.json
```


### My metrics are intermittent / not receiving any metrics

Try a bigger `poll_interval`. CloudWatch returns no data if the period of the metric, by default for AWS supplied metrics this is 300 seconds (5 minutes), is less than the `poll_interval`. Try out a period of 600 seconds and a poll interval of 600 seconds.

### IAM Permission errors

Make sure your IAM role/user has the required permissions:

```yaml
"cloudwatch:GetMetricData",
"cloudwatch:ListMetrics"
```

The following IAM permissions are required for transit gateways to work:

```yaml
"ec2:DescribeTags",
"ec2:DescribeInstances",
"ec2:DescribeRegions",
"ec2:DescribeTransitGateway*"
```

